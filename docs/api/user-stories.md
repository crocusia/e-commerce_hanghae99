# 이커머스 - 유저 스토리

**핵심 기능**
- 상품 카탈로그와 재고 관리 시스템
- 주문/결제 프로세스 (잔액 기반 결제)
- 선착순 쿠폰 시스템 (1인 1매)
- 외부 데이터 플랫폼 연동

---

## 1. 상품 카탈로그와 재고 관리 시스템

### 1.1 상품 조회

**US-001: 상품 목록 조회**
- As a 고객
- I want to 상품 목록을 조회하고
- So that 원하는 상품을 선택할 수 있다
- **인수 조건:**
  - 상품명, 가격을 표시한다
  - 각 상품의 재고 상태(판매 중, 품절 임박, 품절)를 표시한다
  - 품절된 상품은 구매 불가 표시를 한다

**US-002: 상품 상세 정보 확인**
- As a 고객
- I want to 상품의 상세 정보(이름, 가격, 설명)를 확인하고
- So that 구매 결정을 내릴 수 있다
- **인수 조건:**
  - 상품명, 가격, 상세 설명, 이미지를 표시한다
  - 현재 재고 상태를 실시간으로 표시한다
  - 품절 시 '품절' 상태를 명확히 표시한다

### 1.2 재고 관리

**US-003: 재고 수량 및 상태 확인**
- As a 고객
- I want to 상품의 재고 상태를 확인하고
- So that 구매 가능 여부를 판단할 수 있다
- **인수 조건:**
  - 재고 상태를 3단계로 표시한다
    - 판매 중: 재고가 충분함 (예: 재고 10개 이상)
    - 품절 임박: 재고가 얼마 남지 않음 (예: 재고 1~9개)
    - 품절: 재고가 없음 (재고 0개)
  - 품절 임박 시 "품절 임박" 메시지를 표시한다
  - 품절 시 구매 버튼을 비활성화한다

**US-04: 재고 부족 시 구매 제한**
- As a 시스템
- I want to 재고가 부족한 상품의 주문을 자동으로 차단하고
- So that 과다 판매를 방지할 수 있다
- **인수 조건:**
  - 장바구니 담기 시 현재 재고를 확인한다
  - 재고가 없으면 장바구니 담기를 차단한다
  - 주문 생성 시 재고를 재확인한다
  - 재고 부족 시 명확한 에러 메시지를 반환한다

---

## 2. 주문/결제 프로세스

### 2.1 장바구니

**US-05: 장바구니 담기**
- As a 고객
- I want to 상품을 장바구니에 담고
- So that 나중에 한번에 구매할 수 있다
- **인수 조건:**
  - 재고가 있는 상품만 장바구니에 담을 수 있다
  - 장바구니에 담을 때 현재 재고를 확인한다
  - 동일 상품 추가 시 수량이 증가한다
  - 재고보다 많은 수량을 담으려고 하면 차단한다

**US-06: 장바구니 조회**
- As a 고객
- I want to 장바구니에 담긴 상품 목록과 총 금액을 확인하고
- So that 구매 전에 주문 내역을 검토할 수 있다
- **인수 조건:**
  - 상품명, 가격, 수량, 소계를 표시한다
  - 각 상품의 현재 재고 상태를 표시한다
  - 전체 주문 금액을 계산하여 표시한다
  - 적용 가능한 쿠폰이 있다면 할인 금액을 표시한다

**US-07: 장바구니 수량 변경**
- As a 고객
- I want to 장바구니에 담긴 상품의 수량을 변경하고
- So that 구매 수량을 조정할 수 있다
- **인수 조건:**
  - 수량 변경 시 현재 재고를 확인한다
  - 재고보다 많은 수량으로 변경할 수 없다
  - 재고가 부족하면 변경 불가 메시지를 표시한다
  - 수량 변경 시 즉시 총 금액이 업데이트된다

**US-08: 장바구니 항목 삭제**
- As a 고객
- I want to 장바구니에서 특정 상품을 삭제하고
- So that 구매하지 않을 상품을 제거할 수 있다
- **인수 조건:**
  - 선택한 상품만 장바구니에서 삭제된다
  - 삭제 후 총 금액이 즉시 업데이트된다
  - 장바구니가 비어있으면 주문 진행을 막는다

### 2.2 주문 생성

**US-09: 주문 생성**
- As a 고객
- I want to 장바구니의 상품으로 주문을 생성하고
- So that 상품을 구매할 수 있다
- **인수 조건:**
  - 주문 생성 시 모든 상품의 재고를 재확인한다
  - 재고가 부족한 상품이 있으면 주문 생성을 차단한다
  - 주문 생성 성공 시 해당 수량만큼 재고를 예약(차감)한다
  - 주문번호를 생성하고 주문 상태를 '결제대기'로 설정한다
  - 쿠폰이 적용된 경우 할인 금액을 계산한다

**US-10: 재고 검증 및 예약**
- As a 시스템
- I want to 주문 생성 시 재고를 원자적으로 검증하고 예약하고
- So that 동시 주문 시에도 재고 초과 판매를 방지할 수 있다
- **인수 조건:**
  - 재고 확인과 차감이 원자적으로 처리된다 (트랜잭션)
  - 재고 부족 시 명확한 에러 메시지를 반환한다
  - 동시에 여러 주문이 발생해도 재고 수량을 초과하지 않는다
  - 비관적 락 또는 낙관적 락을 활용하여 동시성을 제어한다

### 2.3 결제 처리 (잔액 기반)

**US-11: 잔액 기반 결제 처리**
- As a 고객
- I want to 내 잔액으로 주문 금액을 결제하고
- So that 상품을 최종적으로 구매할 수 있다
- **인수 조건:**
  - 결제 전 고객의 현재 잔액을 확인한다
  - 잔액이 주문 금액보다 부족하면 결제를 차단한다
  - 결제 성공 시 잔액에서 주문 금액을 차감한다
  - 결제 성공 시 주문 상태를 '결제완료'로 변경한다
  - 결제 성공 시 적용된 쿠폰을 '사용완료' 상태로 변경한다
  - 결제 성공 시 재고를 최종 확정한다
  - 잔액 차감과 주문 상태 변경이 원자적으로 처리된다

**US-12: 결제 실패 및 타임아웃 처리**
- As a 시스템
- I want to 결제 실패 또는 타임아웃 시 주문을 자동으로 취소하고
- So that 재고와 쿠폰의 정합성을 유지할 수 있다
- **인수 조건:**
  - 잔액 부족으로 결제 실패 시 예약된 재고를 원복한다
  - 결제 실패 시 쿠폰을 미사용 상태로 복원한다
  - 결제 대기 시간 초과 시 자동으로 주문을 취소한다
  - 고객에게 실패 사유를 명확히 전달한다
  - 재고 복원과 쿠폰 복원이 원자적으로 처리된다

---

## 3. 선착순 쿠폰 시스템 (1인 1매)

### 3.1 쿠폰 발급

**US-13: 선착순 쿠폰 발급 (1인 1매)**
- As a 고객
- I want to 선착순 쿠폰을 발급받고
- So that 할인 혜택을 받을 수 있다
- **인수 조건:**
  - 쿠폰 발급 가능 수량을 실시간으로 확인한다
  - 1인 1매 제한을 검증한다 (동일 고객이 이미 발급받았는지 확인)
  - 이미 발급받은 고객은 추가 발급을 차단한다
  - 발급 가능한 경우에만 쿠폰을 발급한다
  - 쿠폰 유효기간을 설정한다
  - 발급 성공 시 즉시 사용 가능 상태로 변경한다
  - 쿠폰 소진 시 "선착순 마감" 메시지를 표시한다

**US-14: 쿠폰 발급 동시성 제어**
- As a 시스템
- I want to 동시에 여러 고객이 쿠폰을 요청해도 설정된 수량만큼만 발급하고
- So that 쿠폰 과다 발급을 방지할 수 있다
- **인수 조건:**
  - 발급 수량 확인과 차감이 원자적으로 처리된다
  - 1인 1매 검증과 발급이 원자적으로 처리된다
  - 동시 요청 시에도 총 발급 수량을 초과하지 않는다
  - 동일 고객의 중복 발급을 완벽하게 차단한다
  - 초과 발급 시도 시 명확한 에러 메시지를 반환한다
  - Redis 분산 락 또는 DB 비관적 락을 활용한다
  - 레이스 컨디션을 방지한다

### 3.2 쿠폰 조회 및 사용

**US-15: 보유 쿠폰 조회**
- As a 고객
- I want to 결제 단계에서 내가 보유한 쿠폰 목록을 조회하고
- So that 사용 가능한 쿠폰을 확인하고 적용할 수 있다
- **인수 조건:**
  - 현재 사용 가능한 쿠폰만 표시한다
  - 쿠폰명, 할인 금액/비율, 유효기간을 표시한다
  - 현재 주문에 적용 가능한 쿠폰인지 표시한다
  - 이미 사용된 쿠폰은 표시하지 않는다
  - 유효기간이 지난 쿠폰은 표시하지 않는다

**US-16: 주문 시 쿠폰 적용**
- As a 고객
- I want to 주문 시 보유한 쿠폰을 적용하고
- So that 할인된 가격으로 구매할 수 있다
- **인수 조건:**
  - 보유한 쿠폰 중 사용 가능한 쿠폰을 선택할 수 있다
  - 쿠폰 적용 시 할인 금액을 즉시 계산하여 표시한다
  - 쿠폰 사용 조건(최소 주문 금액 등)을 검증한다
  - 한 주문에 하나의 쿠폰만 적용 가능하다
  - 쿠폰 적용 후 최종 결제 금액을 표시한다

**US-17: 쿠폰 사용 처리**
- As a 시스템
- I want to 결제 성공 후 쿠폰을 사용 완료 상태로 변경하고
- So that 중복 사용을 방지할 수 있다
- **인수 조건:**
  - 결제 성공 시에만 쿠폰을 사용 완료로 처리한다
  - 쿠폰 사용 이력(주문번호, 사용 일시)을 기록한다
  - 사용 완료된 쿠폰은 더 이상 사용할 수 없다
  - 결제 실패 시 쿠폰을 미사용 상태로 복원한다
  - 쿠폰 상태 변경이 원자적으로 처리된다

**US-18: 쿠폰 유효성 검증**
- As a 시스템
- I want to 쿠폰 사용 시 모든 조건을 엄격하게 검증하고
- So that 유효하지 않은 쿠폰 사용을 방지할 수 있다
- **인수 조건:**
  - 쿠폰 유효기간을 확인한다
  - 쿠폰이 이미 사용되었는지 확인한다
  - 쿠폰의 최소 주문 금액 조건을 검증한다
  - 쿠폰 적용 가능 상품인지 확인한다
  - 쿠폰 소유자가 맞는지 확인한다
  - 검증 실패 시 명확한 실패 사유를 반환한다
  - 검증 과정이 원자적으로 처리되어 경합 상태를 방지한다

---

## 4. 외부 데이터 플랫폼 연동

### 4.1 이벤트 데이터 전송

**US-19: 주요 이벤트 데이터 전송**
- As a 시스템
- I want to 주요 비즈니스 이벤트를 외부 데이터 플랫폼으로 전송하고
- So that 데이터 분석 및 모니터링을 수행할 수 있다
- **전송 대상 이벤트:**
  - 주문 생성 (주문번호, 상품ID, 수량, 금액, 타임스탬프)
  - 결제 완료 (주문번호, 결제 금액, 결제 방식, 타임스탬프)
  - 쿠폰 발급 (쿠폰ID, 고객ID, 타임스탬프)
  - 쿠폰 사용 (쿠폰ID, 주문번호, 할인 금액, 타임스탬프)
- **인수 조건:**
  - 이벤트 발생 시 비동기로 데이터를 전송한다
  - 전송 실패 시 재시도한다 (최대 3회)
  - 전송 실패가 비즈니스 로직을 차단하지 않는다
